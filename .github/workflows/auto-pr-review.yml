name: Auto PR

on:
  push:
    branches-ignore:
      - main
      - develop
      - 'release/**'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Create PR
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH="${GITHUB_REF#refs/heads/}"
        
        if [[ $BRANCH =~ ^(feature|fix|docs|refactor|test)/ ]]; then
          TYPE="${BASH_REMATCH[1]}"
        else
          TYPE="feature"
        fi
        
        TYPE_UPPER=$(echo "$TYPE" | tr '[:lower:]' '[:upper:]')
        
        EXISTING=$(gh pr list --head "$BRANCH" --base develop --json number -q '.[0].number')
        
        if [ -z "$EXISTING" ]; then
          gh label create "$TYPE" --color "0366d6" --description "Auto-generated $TYPE label" 2>/dev/null || true
          gh label create "auto-generated" --color "cccccc" --description "Auto-generated PR" 2>/dev/null || true
          
          gh pr create \
            --base develop \
            --head "$BRANCH" \
            --title "[$TYPE_UPPER] ${{ github.event.head_commit.message }}" \
            --body "Auto-generated PR from $BRANCH" \
            --label "$TYPE,auto-generated" 2>/dev/null || \
          gh pr create \
            --base develop \
            --head "$BRANCH" \
            --title "[$TYPE_UPPER] ${{ github.event.head_commit.message }}" \
            --body "Auto-generated PR from $BRANCH"
        fi
