name: Auto PR & Review

on:
  push:
    branches-ignore:
      - main
      - develop
      - 'release/**'

jobs:
  create-pull-request:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Extract branch info
      id: branch_info
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
        
        # Extract type from branch name (feature/fix/docs etc)
        if [[ $BRANCH_NAME =~ ^(feature|fix|docs|refactor|test)/ ]]; then
          TYPE="${BASH_REMATCH[1]}"
        else
          TYPE="feature"
        fi
        echo "type=$TYPE" >> $GITHUB_OUTPUT
    
    - name: Create or Update Pull Request
      uses: peter-evans/create-pull-request@v6
      id: cpr
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        base: develop
        branch: ${{ steps.branch_info.outputs.branch }}
        title: "[${{ steps.branch_info.outputs.type | upper }}] ${{ github.event.head_commit.message }}"
        body: |
          ## ìë™ ìƒì„±ëœ PR
          
          ### ë³€ê²½ì‚¬í•­
          ${{ github.event.head_commit.message }}
          
          ### ì²´í¬ë¦¬ìŠ¤íŠ¸
          - [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
          - [ ] í…ŒìŠ¤íŠ¸ í†µê³¼
          - [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
          
          ### ê´€ë ¨ ì •ë³´
          - Branch: `${{ steps.branch_info.outputs.branch }}`
          - Commit: `${{ github.sha }}`
          - Author: @${{ github.actor }}
          
          ---
          ğŸ¤– *ì´ PRì€ GitHub Actionsì— ì˜í•´ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.*
        labels: |
          ${{ steps.branch_info.outputs.type }}
          auto-generated
        draft: false
    
    - name: Check outputs
      if: steps.cpr.outputs.pull-request-number
      run: |
        echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
        echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"

  ai-code-review:
    runs-on: ubuntu-latest
    needs: create-pull-request
    if: github.event_name == 'pull_request' || needs.create-pull-request.outputs.pull-request-number != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: AI Code Review
      uses: coderabbitai/ai-pr-reviewer@latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      with:
        debug: false
        review_simple_changes: false
        review_comment_lgtm: false
        openai_light_model: gpt-4o-mini
        openai_heavy_model: gpt-4o
